<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Schepen in de Buurt</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f0f0f0; }
    .card { background: white; padding: 10px 15px; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .error { color: red; }
  </style>
</head>
<body>
  <h1>Schepen in de buurt (2 km)</h1>
  <p id="status">Locatie wordt bepaald...</p>
  <div id="ships"></div>

  <script>
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        const ws = new WebSocket("wss://stream.aisstream.io/v0/ais");
        const ships = new Set();

        ws.onopen = () => {
          const message = {
            Apikey: "tryme",
            BoundingBoxes: [
              [
                [lat - 0.018, lon - 0.028],
                [lat + 0.018, lon + 0.028]
              ]
            ]
          };
          ws.send(JSON.stringify(message));
        };

        ws.onmessage = (event) => {
          const data = JSON.parse(event.data);
          if (data.Messages) {
            data.Messages.forEach(msg => {
              const name = msg.Meta?.ShipName || msg.Meta?.MMSI;
              if (name && !ships.has(name)) {
                ships.add(name);
              }
            });
            const shipList = Array.from(ships).slice(0, 10);
            document.getElementById("status").textContent = shipList.length ? "" : "Geen schepen gevonden in de buurt.";
            const container = document.getElementById("ships");
            container.innerHTML = "";
            shipList.forEach(ship => {
              const div = document.createElement("div");
              div.className = "card";
              div.textContent = ship;
              container.appendChild(div);
            });
          }
        };

        ws.onerror = () => {
          document.getElementById("status").innerHTML = "<span class='error'>Fout bij het verbinden met AISStream.</span>";
        };

        ws.onclose = () => console.log("Verbinding gesloten.");
      },
      () => {
        document.getElementById("status").innerHTML = "<span class='error'>Locatie kan niet worden bepaald.</span>";
      },
      { enableHighAccuracy: true }
    );
  </script>
</body>
</html>
